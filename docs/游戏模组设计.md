# 游戏模组设计

## 核心原则：数据与逻辑分离

**为什么分离？**
- 编辑器：需要完整插件系统（通过钩子动态收集）
- 播放器：只需要积木定义和代码生成器（直接导入纯数据）
- 导出HTML：独立文件，无运行时插件系统

## 标准目录结构

```
gamemods/
  time-system/
    ├── blocks.ts          （纯数据：积木块定义）
    ├── generators.ts      （纯数据：代码生成器）
    ├── variables.ts       （纯数据：预定义变量）
    ├── docs.ts            （纯数据：使用文档）
    ├── TimeSystemPlugin.ts（逻辑：运行时函数 + 钩子）
    └── index.ts           （统一导出）
  blockly.ts               （汇总所有模组的blocks和generators）
  index.ts                 （汇总所有模组插件）
```

## 与Blockly交互机制

### 第一步：定义积木块（blocks.ts）

```typescript
export const TIME_BLOCKS = [
  {
    type: 'time_add',              // 积木块ID
    message0: '时间流逝 %1 分钟',  // 显示文本
    args0: [{
      type: 'input_value',
      name: 'MINUTES',
      check: 'Number'              // 只接受数字输入
    }],
    previousStatement: null,       // 可以连接上一个积木
    nextStatement: null,           // 可以连接下一个积木
    colour: 45,                    // 颜色（橙色）
    tooltip: '增加游戏时间...'
  }
];
```

### 第二步：定义代码生成器（generators.ts）

```typescript
export const TIME_GENERATORS = {
  time_add: (block, generator) => {
    // 获取输入值
    const minutes = generator.valueToCode(
      block, 
      'MINUTES', 
      generator.ORDER_NONE
    ) || '0';
    
    // 生成JavaScript代码（调用运行时函数）
    return `fns.addTime(${minutes});\n`;
  }
};
```

**生成的代码示例**
```javascript
fns.addTime(30);  // 时间流逝30分钟
```

### 第三步：注册运行时函数（Plugin.ts）

```typescript
export class TimeSystemPlugin extends PluginBase {
  private runtimePlugin: RuntimePlugin;
  
  protected async onInstall(): Promise<void> {
    // 获取RuntimePlugin实例
    this.runtimePlugin = this.context.getPlugin('basicmod.runtime');
    
    // 注册函数到fns对象
    this.runtimePlugin.registerFunction('addTime', (minutes) => {
      this.addTime(minutes);  // 实际执行逻辑
    });
  }
  
  private addTime(minutes: number): void {
    // 读取变量
    const vars = this.runtimePlugin.vars;
    vars['minute'] += minutes;
    
    // 处理进位
    if (vars['minute'] >= 60) {
      vars['hour'] += Math.floor(vars['minute'] / 60);
      vars['minute'] = vars['minute'] % 60;
    }
  }
}
```

### 第四步：通过钩子注册积木块

```typescript
hooks = {
  // 注册积木块定义
  'blockly:register-blocks': (blocks) => {
    return [...blocks, ...TIME_BLOCKS];
  },
  
  // 注册代码生成器
  'blockly:register-generators': (generators) => {
    return { ...generators, ...TIME_GENERATORS };
  },
  
  // 注册工具箱分类
  'blockly:register-toolbox-categories': (categories) => {
    return [...categories, {
      kind: 'category',
      name: '时间',
      colour: 45,
      contents: [
        { kind: 'block', type: 'time_add' }
      ]
    }];
  }
};
```

## 完整交互流程

```
用户拖拽积木 "时间流逝 30 分钟"
    ↓
Blockly编辑器保存workspace状态
    ↓
保存到 node.pluginData['blockly.scripts']
    ↓
播放器进入节点
    ↓
BlocklyExecutor读取脚本
    ↓
调用生成器：TIME_GENERATORS.time_add()
    ↓
生成代码：fns.addTime(30);
    ↓
执行代码（沙箱环境）
    ↓
调用 RuntimePlugin.fns.addTime(30)
    ↓
执行 TimeSystemPlugin.addTime(30)
    ↓
修改变量：minute += 30，处理进位
```

## 开发新模组步骤

### 1. 创建目录和文件

```bash
gamemods/
  my-mod/
    ├── blocks.ts
    ├── generators.ts
    ├── variables.ts
    ├── MyModPlugin.ts
    └── index.ts
```

### 2. 定义积木块（blocks.ts）

```typescript
export const MYMOD_BLOCKS = [
  {
    type: 'mymod_action',
    message0: '执行 %1',
    args0: [{ type: 'field_input', name: 'ACTION' }],
    previousStatement: null,
    nextStatement: null,
    colour: 120
  }
];
```

### 3. 定义生成器（generators.ts）

```typescript
export const MYMOD_GENERATORS = {
  mymod_action: (block) => {
    const action = block.getFieldValue('ACTION');
    return `fns.doAction('${action}');\n`;
  }
};
```

### 4. 创建插件类（MyModPlugin.ts）

```typescript
export class MyModPlugin extends PluginBase {
  metadata = {
    id: 'gamemod.mymod',
    name: '我的模组',
    category: 'gamemod',
    requires: ['basicmod.runtime']
  };
  
  private runtimePlugin: RuntimePlugin;
  
  protected async onInstall(): Promise<void> {
    this.runtimePlugin = this.context.getPlugin('basicmod.runtime');
    
    // 注册运行时函数
    this.runtimePlugin.registerFunction('doAction', (action) => {
      console.log('执行动作:', action);
    });
  }
  
  hooks = {
    'blockly:register-blocks': (blocks) => 
      [...blocks, ...MYMOD_BLOCKS],
    'blockly:register-generators': (gens) => 
      ({ ...gens, ...MYMOD_GENERATORS })
  };
}
```

### 5. 在 blockly.ts 中汇总

```typescript
import { MYMOD_BLOCKS } from './my-mod/blocks.js';
import { MYMOD_GENERATORS } from './my-mod/generators.js';

export const ALL_GAMEMOD_BLOCKS = [
  ...TIME_BLOCKS,
  ...MYMOD_BLOCKS  // 新增
];

export const ALL_GAMEMOD_GENERATORS = {
  ...TIME_GENERATORS,
  ...MYMOD_GENERATORS  // 新增
};
```

### 6. 在 index.ts 中导出

```typescript
import { MyModPlugin } from './my-mod/index.js';

export function createGameModPlugins() {
  return [
    new TimeSystemPlugin(),
    new MyModPlugin()  // 新增
  ];
}
```

## 关键约束

**blocks和generators必须是纯数据**
- ❌ 不能依赖类实例
- ❌ 不能包含闭包
- ✅ 必须可以被JSON序列化（除了函数体）
- ✅ 必须可以直接导入到播放器

**代码生成器只能调用fns对象**
```javascript
// ✅ 正确
return `fns.addTime(30);\n`;

// ❌ 错误（播放器找不到TimeSystemPlugin）
return `TimeSystemPlugin.addTime(30);\n`;
```

**运行时函数通过RuntimePlugin注册**
```typescript
// ✅ 正确
this.runtimePlugin.registerFunction('addTime', this.addTime.bind(this));

// ❌ 错误（全局污染）
window.addTime = this.addTime;
```

## 沙箱执行环境

**BlocklyExecutor 执行脚本时**
```typescript
const sandbox = {
  fns: runtimePlugin.fns,      // 所有注册的函数
  $vars: runtimePlugin.vars,   // 所有变量
  console: { log: console.log },
  // 禁止访问其他全局对象
};

const executor = new Function(...Object.keys(sandbox), code);
executor(...Object.values(sandbox));
```

**安全保证**
- 脚本无法访问 `window`、`document`
- 脚本无法访问插件类实例
- 脚本只能调用 `fns` 中注册的函数


