# 游戏模组

## 定义

GameMod 是 category 为 'gamemod' 的插件，扩展游戏机制（时间、库存、战斗等）

## 新架构（v3.1+）

**文件夹管理** - 每个GameMod使用独立文件夹，关注点分离

```
shared/plugins/gamemods/
├── backrooms/
│   ├── index.ts              # 统一导出
│   ├── BackroomsPlugin.ts    # 插件逻辑
│   ├── variables.ts          # 变量定义（单一数据源）
│   └── docs.ts               # 文档内容
└── time-system/
    ├── index.ts              # 统一导出
    ├── TimeSystemPlugin.ts   # 插件逻辑
    ├── variables.ts          # 变量定义（单一数据源）
    └── docs.ts               # 文档内容
```

## 核心职责

**扩展Runtime** - 注册自定义函数到RuntimePlugin，供模板和Blockly调用  
**扩展Blockly** - 注册积木块和代码生成器，提供可视化编程界面  
**定义变量** - 在 variables.ts 中定义（单一数据源，自动计数）  
**提供文档** - 在 docs.ts 中定义，getDocs()调用它

## 代码示例

### 1. variables.ts（单一数据源）
```typescript
import type { VariableDefinition } from '../../../types/index.js';

export const TIME_SYSTEM_VARIABLES: VariableDefinition[] = [
  { id: 'minute', label: '分钟', type: 'number', defaultValue: 0, source: 'plugin', pluginId: 'gamemod.time-system' },
  { id: 'hour', label: '小时', type: 'number', defaultValue: 0, source: 'plugin', pluginId: 'gamemod.time-system' },
  { id: 'day', label: '天', type: 'number', defaultValue: 1, source: 'plugin', pluginId: 'gamemod.time-system' },
  { id: 'month', label: '月', type: 'number', defaultValue: 1, source: 'plugin', pluginId: 'gamemod.time-system' }
];

export const TIME_SYSTEM_VARIABLE_COUNT = TIME_SYSTEM_VARIABLES.length;
```

### 2. docs.ts（文档内容）
```typescript
import type { GameModDocs } from '../types.js';
import { TIME_SYSTEM_VARIABLE_COUNT } from './variables.js';

export function getTimeSystemDocs(): GameModDocs {
  return {
    name: '时间',
    description: `时间流逝系统（${TIME_SYSTEM_VARIABLE_COUNT}个变量）`,
    variables: [...],
    functions: [...],
    usage: { setup: [...] }
  };
}
```

### 3. TimeSystemPlugin.ts（插件逻辑）
```typescript
import { getTimeSystemDocs } from './docs.js';

export class TimeSystemPlugin extends PluginBase {
  metadata: PluginMetadata = {
    id: 'gamemod.time-system',
    name: '时间',
    category: 'gamemod',
    requires: ['basicmod.runtime']
  };
  
  protected async onInstall(): Promise<void> {
    this.runtimePlugin = this.context.getPlugin('basicmod.runtime');
    this.registerTimeFunctions();
  }
  
  static getDocs(): GameModDocs {
    return getTimeSystemDocs();
  }
}
```

### 4. index.ts（统一导出）
```typescript
export { TimeSystemPlugin } from './TimeSystemPlugin.js';
export { TIME_SYSTEM_VARIABLES, TIME_SYSTEM_VARIABLE_COUNT } from './variables.js';
export { getTimeSystemDocs } from './docs.js';
```

## 前端注入器

```
frontend/src/components/ScriptHelper/
└── injectors/
    ├── BackroomsInjector.ts    # Backrooms变量注入
    └── TimeSystemInjector.ts   # 时间系统变量注入
```

注入器从 `variables.ts` 导入变量数组，确保前后端使用同一数据源。

## 开发规范

### 变量定义
- 在 `variables.ts` 中定义，导出数组和计数常量
- 前端注入器导入该数组，无需重复定义
- 文档使用计数常量，自动同步

### Blockly 积木块
- 命名前缀：模组简称（time_add / backrooms_use_almond_water）
- 代码生成器：调用 fns.funcName() 格式
- 工具箱分类：使用模组名，colour 统一 45/65

### Runtime 函数
- 注册时机：onInstall() 中调用 registerFunction()
- 变量访问：通过 this.runtimePlugin.vars['变量名']
- 容错处理：使用 || 默认值，不抛错

## 内置模组

**TimeSystemPlugin** - 时间流逝系统（4个变量）
- 变量：minute / hour / day / month
- 函数：addTime(minutes) - 增加时间并自动进位
- 积木块：时间流逝、当前时间

**BackroomsPlugin** - 后室生存游戏（52个变量）
- 8个核心生存状态、10个物资、8个装备、8个进度、12个状态标记、6个环境因素
- 函数：useAlmondWater / rollEncounter / enterLevel / tryEscape 等10个
- 积木块：使用物资、遭遇检定、进入Level、战斗逃脱等

## 启用流程

1. 插件商店启用模组
2. 侧边栏显示文档（自动计数）
3. 点击"注入变量（N个）"按钮初始化变量
4. Blockly 工具箱自动添加积木块
5. 模板中可使用 `{{funcName()}}` 调用注册的函数
