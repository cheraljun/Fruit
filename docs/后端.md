# 后端

## 核心职责

**认证** - JWT + bcrypt，邮箱验证码（30分钟）
**持久化** - 文件系统，AtomicFileWriter原子写入
**图片** - WebP压缩，hash去重
**清理** - CleanupService每日0:00自动删除未引用图片
**桌面模式** - 检测DESKTOP_MODE环境变量，提供前端静态文件服务

## 分层架构

```
routes/         HTTP端点
services/       Auth、Story、Email、Image、Cleanup
repositories/   FileSystemRepository
infrastructure/ AtomicFileWriter、EmailSender
middleware/     JWT验证、错误处理、异步包装
```

## 文件结构

```
userdata/用户名/
  .author.json       认证信息（密码hash、邮箱）
  drafts/*.json      草稿区（可编辑）
  published/*.json   发布区（只读）
  pictures/*.webp    图片资源（hash命名）
```

