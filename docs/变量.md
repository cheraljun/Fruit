# 变量系统

## 单向数据流

```
定义层：VariableManager（左侧栏） → story.variables
  ↓
注入层：blocklyInit.ts → Blockly工作区（单向）
  ↓
执行层：BlocklyExecutor → RuntimePlugin的vars对象
```

数据只能向下流动，不能回流

## 核心组件

**VariableManager** - 侧边栏CRUD，直接修改story.variables，禁用Blockly内置变量UI

**blocklyInit.ts** - 重写代码生成器，输出`vars['变量名']`格式，使用forBlock注册

**BlocklyExecutor** - Function构造器沙箱执行，注入vars和fns（自定义函数）

## 模板系统

**RuntimePlugin.processTemplate()** - 处理 `{{表达式}}`

支持语法：
- 变量访问：`{{varName}}` 或 `{{$vars.varName}}`
- 函数调用：`{{funcName()}}` 或 `{{$fn.funcName()}}`
- 三元运算：`{{condition ? value1 : value2}}`

游戏模组通过registerFunction()注册自定义函数供模板调用

