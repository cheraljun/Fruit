# 变量系统

## 架构（v3.2+ 动态注册）

```
定义层：VariableDefinition[] 在 variables.ts 中定义
  ↓
注册层：插件通过 plugin:get-variables 钩子注册
  ↓
编辑器：ScriptHelper 动态收集 → VariableManager CRUD → story.variables
  ↓
注入层：blocklyInit 注入 Blockly 工作区（单向）
  ↓
执行层：BlocklyExecutor 生成 vars['变量名'] 代码 → RuntimePlugin.vars
```

## 动态注册机制

**插件定义** - 在 `variables.ts` 导出 `PLUGIN_VARIABLES: VariableDefinition[]`

**钩子注册** - 插件实现 `plugin:get-variables` 钩子返回变量数组

**前端收集** - `pluginSystem.trigger('plugin:get-variables', [])` 动态收集

**自动注入** - ScriptHelper 自动生成注入按钮，按模组ID过滤变量

## 模板系统

**RuntimePlugin.processTemplate()** - 处理 `{{表达式}}`

语法：
- 变量：`{{varName}}` 或 `{{$vars.varName}}`
- 函数：`{{funcName()}}` 或 `{{$fn.funcName()}}`
- 三元：`{{health > 50 ? "健康" : "虚弱"}}`

## Blockly集成

**代码生成** - `vars['varName']` 格式访问RuntimePlugin.vars对象

**变量块重写** - variables_set/get/math_change 生成vars['id']代码

**单向流** - 变量只能在侧边栏定义，Blockly工作区只使用不创建

