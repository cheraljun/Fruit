# 变量系统 - 单向数据流

## 核心原则

变量是**单向数据流**：定义 → 初始化 → 读取 → 修改 → 保存

## 变量定义（元数据层）

**在编辑器中定义**
```typescript
interface VariableDefinition {
  id: string;              // 变量ID（如 "health"）
  label: string;           // 显示名称（如 "生命值"）
  type: 'number' | 'string' | 'boolean';
  defaultValue: number | string | boolean;
  description?: string;    // 描述
  source?: 'user' | 'plugin';  // 来源
  pluginId?: string;       // 插件ID（如果是插件变量）
  displayInPlayer?: boolean;   // 是否在播放器显示
  displayOrder?: number;       // 显示顺序
}
```

保存在 `story.variables` 数组中。

## 变量存储（运行时层）

**RuntimePlugin 负责存储**
- 播放器启动时，根据 `story.variables` 初始化所有变量
- 使用 `Map<string, any>` 存储变量值
- 提供 `get()` / `set()` / `add()` / `multiply()` 等方法

**初始化流程**
```typescript
// PlayerCore.start()
story.variables.forEach(varDef => {
  runtimePlugin.set(varDef.id, varDef.defaultValue);
});
```

## 变量访问（模板替换）

**语法**
- `{{$vars.health}}` - 读取变量
- `{{$vars.health > 50 ? "健康" : "虚弱"}}` - 条件表达式
- `{{random(1, 10)}}` - 调用辅助函数

**执行时机**
- `content:process` 钩子，在节点文本渲染前执行
- 由 RuntimePlugin 处理
- 返回替换后的文本

**辅助函数**
```javascript
random(min, max)  // 随机数
clamp(val, min, max)  // 限制范围
abs(val)  // 绝对值
floor(val) / ceil(val) / round(val)
min(...values) / max(...values)
```

## 变量修改（Blockly脚本）

**四种脚本类型**
1. `onEnter` - 节点进入时执行
2. `onLeave` - 节点离开时执行
3. `condition` - 选项显示条件（返回 boolean）
4. `onSelect` - 选项被选择时执行

**Blockly 代码生成**
```javascript
// 编辑器中的Blockly生成器
generators['variables_set'] = (block) => {
  const varName = block.getFieldValue('VAR');
  const value = generator.valueToCode(block, 'VALUE');
  return `fns.setVar('${varName}', ${value});\n`;
};
```

**运行时执行**
```javascript
// RuntimePlugin注册函数
registerFunction('setVar', (name, value) => {
  this.variables.set(name, value);
});
```

## 数据流向图

```
编辑器 VariableManager
    ↓ 定义变量
story.variables (元数据)
    ↓ 保存到JSON
后端持久化
    ↓ 加载
播放器 PlayerCore
    ↓ 初始化
RuntimePlugin.variables (Map)
    ↓ 运行时访问
模板替换 / Blockly脚本
    ↓ 修改值
RuntimePlugin.set()
    ↓ 保存进度
SaveState (包含变量)
```

## 插件变量扩展

**插件可以预定义变量**
```typescript
// TimeSystemPlugin
export const TIME_VARIABLES: VariableDefinition[] = [
  { id: 'day', label: '天数', type: 'number', defaultValue: 1 },
  { id: 'hour', label: '小时', type: 'number', defaultValue: 8 }
];
```

**通过钩子注入**
```typescript
hooks = {
  'plugin:get-variables': (vars) => [...vars, ...TIME_VARIABLES]
};
```

**自动合并到 story.variables**
- 编辑器启动时，插件系统触发 `plugin:get-variables` 钩子
- 收集所有插件变量，标记 `source: 'plugin'`
- 用户可以在 VariableManager 中看到并修改默认值

## 单向流动保证

**只有以下路径可以修改变量值**
1. 初始化：从 `story.variables` 读取默认值
2. Blockly脚本：通过 RuntimePlugin 注册的函数
3. 加载存档：恢复保存的变量值

**禁止的操作**
- ❌ 直接修改 `story.variables` 的 `defaultValue`（元数据层不变）
- ❌ 绕过 RuntimePlugin 直接操作变量
- ❌ 在模板中修改变量（模板只读）

**好处**
- 数据流清晰，易于调试
- 避免状态不一致
- 易于实现时间旅行（撤销/重做）


