# 架构

## 分层原则

**前端三层**
- Engine层：纯粹的节点流引擎，零业务逻辑
- Plugin层：通过钩子扩展功能，完全解耦
- UI层：React组件，只负责渲染

**后端三层**
- Service层：业务逻辑，不关心数据来源
- Repository层：数据访问，封装存储细节
- Infrastructure层：原子写入、邮件发送等基础设施

## 核心设计

**Engine职责边界**
- 只管理节点跳转和历史
- 通过事件触发钩子
- 不包含变量、条件、模板等任何业务逻辑

**Plugin通信机制**
- Hook：同步数据转换（`content:process`, `choice:filter`）
- Event：异步事件通知（`node:enter`, `choice:select`）
- Data Store：插件间共享数据

**类型共享**
- `types/index.ts` 前后端复用
- Story、Node、Edge等核心类型统一定义
- 避免类型不一致导致的bug

## 依赖方向

```
UI组件 → PluginSystem → CoreEngine
Service → Repository → Infrastructure
```

依赖只能单向，上层依赖下层，下层不知道上层存在。

## 数据持久化

**原子写入**
- 先写临时文件 `file.tmp.timestamp`
- 再原子重命名（操作系统保证）
- 崩溃不损坏原文件

**文件系统结构**
```
userdata/
  {username}/
    .author.json          （作者信息）
    drafts/               （草稿）
      {storyId}.json
    published/            （发布）
      {storyId}.json
    pictures/             （图片）
      {hash}.webp
```


