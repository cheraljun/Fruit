# 06-技术实现方案

> **从设计到代码：MoScript引擎的Backrooms实现**

---

## MoScript引擎概览

### 核心能力

```yaml
Story Node系统:
  - 节点流叙事
  - 图片驱动模式
  - 选项分支
  - 热区交互

变量系统:
  - 16个全局变量
  - 持久化存储
  - 跨节点传递

Blockly脚本:
  - 可视化编程
  - 逻辑判定
  - 随机生成
  - 数学运算

插件系统:
  - 扩展功能
  - 自定义积木
  - 自定义函数
  - 数据结构
```

---

## BackroomsPlugin设计

### 插件架构

```typescript
// 插件主文件：BackroomsPlugin.ts

class BackroomsPlugin {
  // 插件元数据
  name = "BackroomsPlugin"
  version = "1.0.0"
  description = "Backrooms游戏核心功能"
  
  // 16个全局变量
  variables = {
    // 核心属性（3个）
    sanity: number,      // 理智值，0-100
    health: number,      // 生命值，0-100
    stamina: number,     // 体力值，0-100
    
    // 物资（5个）
    almond_water: number,        // 杏仁水数量
    supplies: number,            // 物资包数量
    flashlight_battery: number,  // 手电筒电量，0-100
    rope: number,                // 绳索数量
    noclip_level: number,        // Noclip等级，0-10
    
    // 进度与状态（6个）
    current_level: number,       // 当前层级（0,1,2,4,5...）
    time_in_level: number,       // 层级内停留时间（分钟）
    survival_days: number,       // 生存天数
    explored_levels: string,     // 已探索层级，如"0,1,4"
    
    // 特殊状态（2个）
    partygoer_infected: boolean, // 派对感染标记
    shadow_intact: boolean,      // 影子完整性
  }
  
  // 10个自定义函数
  functions = [
    checkSanity(),           // 理智检查与警告
    consumeAlmondWater(),    // 使用杏仁水
    consumeSupplies(),       // 使用物资包
    encounterEntity(),       // 实体遭遇判定
    tryNoclip(),            // 尝试Noclip
    searchSupplies(),       // 搜索物资
    changeLevel(),          // 切换层级
    rest(),                 // 休息恢复
    updateTime(),           // 更新时间
    checkGameOver(),        // 检查Game Over条件
  ]
  
  // 10个自定义Blockly积木
  blocks = [
    "理智相关",
    "生命相关",
    "遭遇相关",
    "Noclip相关",
    "物资相关",
  ]
}
```

---

### 变量详细设计

#### 核心属性变量

```typescript
// 1. 理智值（sanity）
{
  name: "sanity",
  type: "number",
  default: 100,
  min: 0,
  max: 100,
  description: "理智值，归零Game Over",
  
  // 变化事件
  onDecrease: {
    threshold_30: "显示警告：理智低下",
    threshold_10: "触发幻觉系统",
    threshold_0: "Game Over: 精神崩溃"
  }
}

// 2. 生命值（health）
{
  name: "health",
  type: "number",
  default: 100,
  min: 0,
  max: 100,
  description: "生命值，归零Game Over",
  
  onDecrease: {
    threshold_30: "显示警告：生命危险",
    threshold_20: "影响理智（-10/小时）",
    threshold_0: "Game Over: 死亡"
  }
}

// 3. 体力值（stamina）
{
  name: "stamina",
  type: "number",
  default: 100,
  min: 0,
  max: 100,
  description: "体力值，影响行动能力",
  
  onDecrease: {
    threshold_30: "无法奔跑",
    threshold_10: "无法跳跃",
    threshold_0: "只能行走"
  }
}
```

---

#### 物资变量

```typescript
// 4. 杏仁水（almond_water）
{
  name: "almond_water",
  type: "number",
  default: 3,
  min: 0,
  max: 99,
  description: "杏仁水瓶数，核心资源",
  
  usage: {
    effect: {
      sanity: +20,
      health: +5,
      stamina: +10
    },
    consume: -1
  }
}

// 5. 物资包（supplies）
{
  name: "supplies",
  type: "number",
  default: 5,
  min: 0,
  max: 50,
  description: "物资包数量",
  
  usage: {
    effect: {
      health: +15,
      stamina: +25
    },
    consume: -1
  }
}

// 6. 手电筒电量（flashlight_battery）
{
  name: "flashlight_battery",
  type: "number",
  default: 100,
  min: 0,
  max: 100,
  description: "手电筒电量百分比",
  
  usage: {
    驱散Smiler: -10,
    照明1分钟: -2,
    Level6照明: -5/分钟
  }
}

// 7. 绳索（rope）
{
  name: "rope",
  type: "number",
  default: 0,
  min: 0,
  max: 3,
  description: "绳索数量，稀有资源",
  
  usage: {
    Drop_Maze: "100%安全通过，消耗1根"
  }
}

// 8. Noclip等级（noclip_level）
{
  name: "noclip_level",
  type: "number",
  default: 0,
  min: 0,
  max: 10,
  description: "Noclip技能等级",
  
  levelMap: {
    0-2: "新手，成功率20%",
    3-5: "学习者，成功率50%",
    6-8: "熟练者，成功率75%",
    9-10: "大师，成功率95%"
  }
}
```

---

#### 进度与状态变量

```typescript
// 9. 当前层级（current_level）
{
  name: "current_level",
  type: "number",
  default: 0,
  description: "当前所在层级编号",
  
  levelMap: {
    0: "Level 0: The Lobby",
    1: "Level 1: Habitable Warehouse",
    4: "Level 4: Abandoned Office",
    5: "Level 5: Terror Hotel",
    11: "Level 11: The Endless City",
    999: "Level Fun =)"
  }
}

// 10. 层级停留时间（time_in_level）
{
  name: "time_in_level",
  type: "number",
  default: 0,
  unit: "分钟",
  description: "当前层级停留时间",
  
  usage: {
    计算环境理智消耗: "每小时检查一次",
    Level5特殊: "60分钟后The Beast出现"
  }
}

// 11. 生存天数（survival_days）
{
  name: "survival_days",
  type: "number",
  default: 0,
  description: "总生存天数",
  
  usage: {
    结局条件: "需≥15天达成完美结局",
    孤独计算: "影响理智消耗"
  }
}

// 12. 已探索层级（explored_levels）
{
  name: "explored_levels",
  type: "string",
  default: "0",
  description: "已探索的层级列表，逗号分隔",
  
  example: "0,1,4,5,11",
  
  usage: {
    结局条件: "需≥8个层级达成完美结局",
    成就系统: "解锁探索成就"
  }
}
```

---

#### 特殊状态变量

```typescript
// 13. 派对感染（partygoer_infected）
{
  name: "partygoer_infected",
  type: "boolean",
  default: false,
  description: "是否被Partygoer感染",
  
  infectionTimeline: {
    0小时: "感染发生",
    6小时: "皮肤开始变黄",
    24小时: "手臂开始延长",
    72小时: "完全转化，Game Over"
  },
  
  cure: {
    method: "喝10瓶杏仁水 + 在Level 4休息48小时",
    success_rate: "50%"
  }
}

// 14. 影子完整（shadow_intact）
{
  name: "shadow_intact",
  type: "boolean",
  default: true,
  description: "影子是否完整",
  
  effect: {
    true: "正常",
    false: "所有治疗无效，持续3天"
  },
  
  lost_by: "被Yellow Hound攻击"
}

// 15-16. 预留扩展变量
{
  name: "custom_flag_1",
  type: "number",
  default: 0,
  description: "扩展标记1，未来功能"
}

{
  name: "custom_flag_2",
  type: "string",
  default: "",
  description: "扩展标记2，未来功能"
}
```

---

### 函数详细设计

#### 函数1: checkSanity()

```typescript
function checkSanity(): void {
  const sanity = getVariable("sanity")
  
  // 理智警告
  if (sanity <= 30 && sanity > 20) {
    showWarning("⚠️ 理智低下")
    // 显示黄色闪烁效果
  }
  
  if (sanity <= 20 && sanity > 10) {
    showWarning("🔴 理智危险")
    // 触发幻觉系统
    triggerHallucination()
  }
  
  if (sanity <= 10 && sanity > 0) {
    showWarning("💀 即将崩溃")
    // 选项扭曲
    distortOptions()
  }
  
  // Game Over检查
  if (sanity <= 0) {
    gameOver("精神崩溃")
  }
}

// 辅助函数：触发幻觉
function triggerHallucination(): void {
  const random = Math.random()
  
  if (random < 0.3) {
    // 30%概率触发幻觉遭遇
    jumpToNode("hallucination_smiler")
  }
}

// 辅助函数：扭曲选项
function distortOptions(): void {
  // 将选项文本替换为误导性文本
  // 实现在前端UI层
}
```

---

#### 函数2: consumeAlmondWater()

```typescript
function consumeAlmondWater(): boolean {
  const almondWater = getVariable("almond_water")
  
  // 检查是否有杏仁水
  if (almondWater <= 0) {
    showMessage("你没有杏仁水了...")
    return false
  }
  
  // 消耗1瓶
  setVariable("almond_water", almondWater - 1)
  
  // 恢复属性
  const sanity = getVariable("sanity")
  const health = getVariable("health")
  const stamina = getVariable("stamina")
  
  setVariable("sanity", Math.min(sanity + 20, 100))
  setVariable("health", Math.min(health + 5, 100))
  setVariable("stamina", Math.min(stamina + 10, 100))
  
  // 显示效果动画
  showEffectAnimation({
    sanity: +20,
    health: +5,
    stamina: +10
  })
  
  // 显示文本
  showMessage("你喝下杏仁水。甜甜的味道让你感到安心。")
  
  return true
}
```

---

#### 函数3: encounterEntity()

```typescript
function encounterEntity(entityType: string): EncounterResult {
  // 实体遭遇判定
  const encounters = {
    "smiler": {
      sanity_damage: -20,
      health_damage: 0,
      description: "黑暗中，一个发光的笑容盯着你..."
    },
    "hound": {
      sanity_damage: -10,
      health_damage: -30,
      description: "四肢着地的人形生物向你奔来！"
    },
    "partygoer": {
      sanity_damage: -30,
      health_damage: -50,
      description: "=) 来参加派对吧！"
    },
    "bone_thief": {
      sanity_damage: 0,
      health_damage: -100,
      description: "墙纸睁开了眼睛..."
    }
  }
  
  const encounter = encounters[entityType]
  
  if (!encounter) {
    console.error(`Unknown entity: ${entityType}`)
    return
  }
  
  // 应用伤害
  let sanity = getVariable("sanity")
  let health = getVariable("health")
  
  sanity += encounter.sanity_damage
  health += encounter.health_damage
  
  setVariable("sanity", Math.max(sanity, 0))
  setVariable("health", Math.max(health, 0))
  
  // 检查Game Over
  checkGameOver()
  
  // 返回遭遇结果
  return {
    entity: entityType,
    damage: encounter,
    survived: sanity > 0 && health > 0
  }
}
```

---

#### 函数4: tryNoclip()

```typescript
function tryNoclip(targetLevel?: number): NoclipResult {
  const noclipLevel = getVariable("noclip_level")
  const stamina = getVariable("stamina")
  
  // 检查体力
  if (stamina < 10) {
    showMessage("你太累了，无法集中精神...")
    return { success: false, reason: "low_stamina" }
  }
  
  // 计算成功率
  let successRate = 0
  if (noclipLevel <= 2) successRate = 0.2
  else if (noclipLevel <= 5) successRate = 0.5
  else if (noclipLevel <= 8) successRate = 0.75
  else successRate = 0.95
  
  // 消耗体力
  setVariable("stamina", stamina - 10)
  
  // 随机判定
  const random = Math.random()
  
  if (random <= successRate) {
    // 成功
    // 增加Noclip经验
    setVariable("noclip_level", Math.min(noclipLevel + 0.1, 10))
    
    // 选择目标层级
    let destination = targetLevel
    if (!destination || noclipLevel < 6) {
      // 低等级随机传送
      destination = getRandomAdjacentLevel()
    }
    
    // 切换层级
    changeLevel(destination)
    
    showMessage("【Noclip成功】")
    
    return { 
      success: true, 
      destination: destination 
    }
  } else {
    // 失败
    handleNoclipFailure(noclipLevel)
    
    return { 
      success: false, 
      reason: "failed" 
    }
  }
}

// 辅助函数：处理Noclip失败
function handleNoclipFailure(level: number): void {
  if (level <= 2) {
    // 卡在墙里
    let health = getVariable("health")
    let sanity = getVariable("sanity")
    
    health -= 20
    sanity -= 25
    
    setVariable("health", Math.max(health, 0))
    setVariable("sanity", Math.max(sanity, 0))
    
    showMessage("你卡在了墙里！剧痛袭来...")
    
    checkGameOver()
  } else if (level <= 5) {
    // 随机传送
    const randomLevel = Math.floor(Math.random() * 10)
    changeLevel(randomLevel)
    
    showMessage("Noclip失败！你被传送到了未知的地方...")
  } else {
    // 轻伤
    let health = getVariable("health")
    health -= 10
    setVariable("health", Math.max(health, 0))
    
    showMessage("Noclip失败，但你只是轻微受伤。")
  }
}
```

---

#### 函数5: searchSupplies()

```typescript
function searchSupplies(): SearchResult {
  const currentLevel = getVariable("current_level")
  
  // 各层级物资掉落率
  const dropRates = {
    0: { almond_water: 0.3, supplies: 0.05, rope: 0.0 },
    1: { almond_water: 0.4, supplies: 0.3, rope: 0.1 },
    4: { almond_water: 1.0, supplies: 0.1, rope: 0.0 }, // 无限杏仁水
    5: { almond_water: 0.15, supplies: 0.25, rope: 0.3 }
  }
  
  const rates = dropRates[currentLevel] || { almond_water: 0.2, supplies: 0.1, rope: 0.05 }
  
  const found = {
    almond_water: 0,
    supplies: 0,
    rope: 0
  }
  
  // 杏仁水判定
  if (Math.random() < rates.almond_water) {
    found.almond_water = currentLevel === 4 ? 5 : 1
  }
  
  // 物资包判定
  if (Math.random() < rates.supplies) {
    found.supplies = 1
  }
  
  // 绳索判定（稀有）
  if (Math.random() < rates.rope) {
    found.rope = 1
  }
  
  // 添加到库存
  if (found.almond_water > 0) {
    const current = getVariable("almond_water")
    setVariable("almond_water", Math.min(current + found.almond_water, 99))
  }
  
  if (found.supplies > 0) {
    const current = getVariable("supplies")
    setVariable("supplies", Math.min(current + found.supplies, 50))
  }
  
  if (found.rope > 0) {
    const current = getVariable("rope")
    setVariable("rope", Math.min(current + found.rope, 3))
  }
  
  // 显示结果
  if (found.almond_water + found.supplies + found.rope === 0) {
    showMessage("你什么也没找到...")
  } else {
    let msg = "你找到了：\n"
    if (found.almond_water > 0) msg += `- 杏仁水 ×${found.almond_water}\n`
    if (found.supplies > 0) msg += `- 物资包 ×${found.supplies}\n`
    if (found.rope > 0) msg += `- 绳索 ×${found.rope}\n`
    showMessage(msg)
  }
  
  // 消耗时间（1-5分钟）
  const time = getVariable("time_in_level")
  setVariable("time_in_level", time + Math.floor(Math.random() * 5) + 1)
  
  return found
}
```

---

#### 函数6: changeLevel()

```typescript
function changeLevel(newLevel: number): void {
  const oldLevel = getVariable("current_level")
  
  // 更新当前层级
  setVariable("current_level", newLevel)
  
  // 重置层级时间
  setVariable("time_in_level", 0)
  
  // 更新已探索列表
  const explored = getVariable("explored_levels")
  const exploredArray = explored.split(",").map(Number)
  
  if (!exploredArray.includes(newLevel)) {
    exploredArray.push(newLevel)
    setVariable("explored_levels", exploredArray.join(","))
    
    // 解锁成就
    unlockAchievement(`探索Level ${newLevel}`)
  }
  
  // 层级切换效果
  showLevelTransition(oldLevel, newLevel)
  
  // 跳转到对应层级入口节点
  const levelNodes = {
    0: "level0_start",
    1: "level1_entrance",
    4: "level4_entrance",
    5: "level5_entrance",
    11: "level11_entrance",
    999: "level_fun_interior"
  }
  
  const targetNode = levelNodes[newLevel] || "level0_start"
  jumpToNode(targetNode)
}
```

---

#### 函数7-10: 其他核心函数

```typescript
// 函数7: rest() - 休息恢复
function rest(duration: number): void {
  // duration单位：分钟
  const currentLevel = getVariable("current_level")
  
  // 恢复率（根据层级）
  const restRates = {
    0: { sanity: 0, health: 2, stamina: 10 },
    1: { sanity: 3, health: 3, stamina: 10 },
    4: { sanity: 10, health: 10, stamina: 10 }, // Level 4最佳
    5: { sanity: -5, health: 0, stamina: 5 }  // Level 5不安全
  }
  
  const rates = restRates[currentLevel] || { sanity: 1, health: 2, stamina: 8 }
  
  // 计算恢复量（每10分钟）
  const intervals = duration / 10
  
  let sanity = getVariable("sanity")
  let health = getVariable("health")
  let stamina = getVariable("stamina")
  
  sanity += rates.sanity * intervals
  health += rates.health * intervals
  stamina += rates.stamina * intervals
  
  setVariable("sanity", Math.min(Math.max(sanity, 0), 100))
  setVariable("health", Math.min(Math.max(health, 0), 100))
  setVariable("stamina", Math.min(Math.max(stamina, 0), 100))
  
  // 消耗时间
  const time = getVariable("time_in_level")
  setVariable("time_in_level", time + duration)
  
  showMessage(`你休息了${duration}分钟...`)
}

// 函数8: updateTime() - 更新时间
function updateTime(minutes: number): void {
  // 更新层级时间
  let time = getVariable("time_in_level")
  time += minutes
  setVariable("time_in_level", time)
  
  // 每60分钟检查一次环境理智消耗
  if (time % 60 === 0) {
    applyEnvironmentalDrain()
  }
  
  // 检查特殊事件
  const currentLevel = getVariable("current_level")
  
  if (currentLevel === 5 && time >= 60) {
    // Level 5: The Beast出现
    jumpToNode("the_beast_appears")
  }
}

// 函数9: applyEnvironmentalDrain() - 应用环境消耗
function applyEnvironmentalDrain(): void {
  const currentLevel = getVariable("current_level")
  
  const drainRates = {
    0: -5,
    1: -3,
    2: -8,
    4: -1,
    5: -15,
    6: -20,
    11: -2
  }
  
  const drain = drainRates[currentLevel] || -5
  
  let sanity = getVariable("sanity")
  sanity += drain
  setVariable("sanity", Math.max(sanity, 0))
  
  // 检查Game Over
  checkGameOver()
}

// 函数10: checkGameOver() - 检查游戏结束条件
function checkGameOver(): void {
  const sanity = getVariable("sanity")
  const health = getVariable("health")
  const partygoerInfected = getVariable("partygoer_infected")
  
  // 理智归零
  if (sanity <= 0) {
    jumpToNode("ending_insanity")
    return
  }
  
  // 生命归零
  if (health <= 0) {
    jumpToNode("ending_death")
    return
  }
  
  // Partygoer转化（72小时后）
  if (partygoerInfected) {
    const infectionTime = getVariable("infection_time")
    if (infectionTime >= 72 * 60) {
      jumpToNode("ending_partygoer")
      return
    }
  }
}
```

---

### Blockly积木设计

#### 积木分类

```yaml
理智相关积木:
  - 当理智低于[X]时
  - 理智增加[X]
  - 理智减少[X]
  - 检查理智状态

生命相关积木:
  - 当生命低于[X]时
  - 生命增加[X]
  - 生命减少[X]
  - 应用伤害[实体]

遭遇相关积木:
  - 遭遇[实体]
  - 随机遭遇判定
  - 逃跑判定（成功率[X]%）
  - 使用物品对抗

Noclip相关积木:
  - 尝试Noclip到Level[X]
  - 检查Noclip等级
  - Noclip等级增加
  - 随机传送

物资相关积木:
  - 获得[物资]×[数量]
  - 使用[物资]
  - 检查物资数量
  - 搜索当前区域
```

---

#### 示例积木实现

**积木1：当理智低于X时**

```javascript
Blockly.Blocks['backrooms_sanity_check'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("当理智低于")
        .appendField(new Blockly.FieldNumber(30, 0, 100), "VALUE")
        .appendField("时");
    this.appendStatementInput("DO")
        .setCheck(null);
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(230);
    this.setTooltip("检查理智值是否低于指定值");
  }
};

// 代码生成
Blockly.JavaScript['backrooms_sanity_check'] = function(block) {
  const value = block.getFieldValue('VALUE');
  const statements = Blockly.JavaScript.statementToCode(block, 'DO');
  
  return `
if (getVariable('sanity') < ${value}) {
  ${statements}
}
  `;
};
```

---

**积木2：遭遇实体**

```javascript
Blockly.Blocks['backrooms_encounter'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("遭遇")
        .appendField(new Blockly.FieldDropdown([
          ["Smiler", "smiler"],
          ["Hound", "hound"],
          ["Burster", "burster"],
          ["Partygoer", "partygoer"],
          ["Bone Thief", "bone_thief"]
        ]), "ENTITY");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(0);
    this.setTooltip("触发实体遭遇");
  }
};

Blockly.JavaScript['backrooms_encounter'] = function(block) {
  const entity = block.getFieldValue('ENTITY');
  
  return `encounterEntity('${entity}');\n`;
};
```

---

**积木3：搜索物资**

```javascript
Blockly.Blocks['backrooms_search'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("搜索当前区域");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(120);
    this.setTooltip("搜索物资，根据层级掉落");
  }
};

Blockly.JavaScript['backrooms_search'] = function(block) {
  return `searchSupplies();\n`;
};
```

---

## 节点数据结构

### StoryNode JSON格式

```json
{
  "id": "level0_corridor_01",
  "title": "Level 0 - 黄色走廊",
  "type": "scene",
  
  "background": {
    "image": "assets/images/level0_corridor.jpg",
    "music": "assets/audio/ambience_level0.mp3",
    "sound": "assets/audio/sfx_fluorescent.mp3"
  },
  
  "content": "你站在一条无尽延伸的走廊中...",
  
  "hotspots": [
    {
      "id": "forward",
      "label": "前方走廊",
      "shape": "rect",
      "position": {"x": 960, "y": 400, "width": 400, "height": 300},
      "target": "level0_corridor_02",
      "condition": null
    },
    {
      "id": "left_door",
      "label": "左侧的门",
      "shape": "rect",
      "position": {"x": 300, "y": 500, "width": 150, "height": 250},
      "target": "level0_room_01",
      "condition": null
    }
  ],
  
  "options": [
    {
      "id": "search",
      "text": "搜索物资",
      "target": "level0_search",
      "script": "searchSupplies()",
      "condition": null,
      "repeatable": true
    },
    {
      "id": "rest",
      "text": "休息片刻",
      "target": "level0_rest",
      "script": "rest(10)",
      "condition": "stamina < 50",
      "repeatable": true
    }
  ],
  
  "scripts": {
    "onEnter": "updateTime(5); applyEnvironmentalDrain();",
    "onExit": null
  },
  
  "tags": ["level0", "corridor", "tutorial"]
}
```

---

## 存档系统设计

### 存档数据结构

```typescript
interface SaveData {
  // 元数据
  version: string,
  timestamp: number,
  playtime: number, // 秒
  
  // 当前状态
  currentNode: string,
  currentLevel: number,
  
  // 所有变量
  variables: {
    sanity: number,
    health: number,
    stamina: number,
    almond_water: number,
    supplies: number,
    flashlight_battery: number,
    rope: number,
    noclip_level: number,
    current_level: number,
    time_in_level: number,
    survival_days: number,
    explored_levels: string,
    partygoer_infected: boolean,
    shadow_intact: boolean,
    custom_flag_1: number,
    custom_flag_2: string
  },
  
  // 访问过的节点（用于重玩分析）
  visitedNodes: string[],
  
  // 已达成成就
  achievements: string[],
  
  // 统计数据
  statistics: {
    deaths: number,
    entities_encountered: { [key: string]: number },
    almond_water_consumed: number,
    noclip_attempts: number,
    noclip_successes: number
  }
}
```

---

### 存档功能实现

```typescript
// 保存游戏
function saveGame(slot: number): boolean {
  const saveData: SaveData = {
    version: "1.0.0",
    timestamp: Date.now(),
    playtime: getTotalPlaytime(),
    
    currentNode: getCurrentNodeId(),
    currentLevel: getVariable("current_level"),
    
    variables: {
      sanity: getVariable("sanity"),
      health: getVariable("health"),
      // ... 其他所有变量
    },
    
    visitedNodes: getVisitedNodes(),
    achievements: getAchievements(),
    statistics: getStatistics()
  }
  
  // 存储到localStorage
  try {
    localStorage.setItem(`backrooms_save_${slot}`, JSON.stringify(saveData))
    return true
  } catch (e) {
    console.error("Save failed:", e)
    return false
  }
}

// 加载游戏
function loadGame(slot: number): boolean {
  try {
    const data = localStorage.getItem(`backrooms_save_${slot}`)
    if (!data) return false
    
    const saveData: SaveData = JSON.parse(data)
    
    // 恢复所有变量
    for (const [key, value] of Object.entries(saveData.variables)) {
      setVariable(key, value)
    }
    
    // 恢复其他状态
    restoreVisitedNodes(saveData.visitedNodes)
    restoreAchievements(saveData.achievements)
    restoreStatistics(saveData.statistics)
    
    // 跳转到保存的节点
    jumpToNode(saveData.currentNode)
    
    return true
  } catch (e) {
    console.error("Load failed:", e)
    return false
  }
}
```

---

## 性能优化

### 资源加载优化

```typescript
// 预加载策略
const preloadQueue = {
  // 关键资源：立即加载
  critical: [
    "level0_corridor.jpg",
    "level0_ambience.mp3",
    "ui_icons.png"
  ],
  
  // 高优先级：后台加载
  high: [
    "level1_warehouse.jpg",
    "smiler_encounter.jpg",
    "hound_encounter.jpg"
  ],
  
  // 低优先级：按需加载
  low: [
    "level5_hotel.jpg",
    "level11_city.jpg"
  ]
}

// 懒加载
function lazyLoadAsset(assetPath: string): Promise<any> {
  if (assetCache.has(assetPath)) {
    return Promise.resolve(assetCache.get(assetPath))
  }
  
  return fetch(assetPath)
    .then(response => response.blob())
    .then(blob => {
      assetCache.set(assetPath, blob)
      return blob
    })
}
```

---

### 节点缓存

```typescript
// 相邻节点预缓存
function precacheAdjacentNodes(currentNodeId: string): void {
  const currentNode = getNode(currentNodeId)
  
  // 缓存所有可能跳转的节点
  const targets = [
    ...currentNode.hotspots.map(h => h.target),
    ...currentNode.options.map(o => o.target)
  ]
  
  targets.forEach(targetId => {
    if (!nodeCache.has(targetId)) {
      loadNodeData(targetId).then(data => {
        nodeCache.set(targetId, data)
      })
    }
  })
}
```

---

## 调试工具

### 开发者控制台

```typescript
// 调试命令
const debugCommands = {
  // 属性修改
  "set sanity [value]": (value: number) => {
    setVariable("sanity", value)
  },
  
  "add almond_water [count]": (count: number) => {
    const current = getVariable("almond_water")
    setVariable("almond_water", current + count)
  },
  
  // 层级跳转
  "goto level [number]": (levelNumber: number) => {
    changeLevel(levelNumber)
  },
  
  // Noclip等级
  "set noclip [level]": (level: number) => {
    setVariable("noclip_level", Math.min(level, 10))
  },
  
  // 显示所有变量
  "show vars": () => {
    console.log(getAllVariables())
  },
  
  // 解锁所有层级
  "unlock all": () => {
    setVariable("explored_levels", "0,1,2,4,5,6,7,11,999")
  }
}
```

---

## 总结：技术实现要点

### 关键技术点

```yaml
1. 变量系统:
   - 16个全局变量覆盖所有状态
   - 类型明确（number/boolean/string）
   - 持久化存储

2. 函数系统:
   - 10个核心函数实现所有逻辑
   - 模块化，易于测试
   - 可扩展

3. Blockly系统:
   - 10个自定义积木
   - 直观的可视化编程
   - 降低内容创作门槛

4. 节点系统:
   - JSON数据驱动
   - 图片驱动模式
   - 热区交互

5. 存档系统:
   - 完整状态保存
   - 多存档槽位
   - 统计数据追踪

6. 性能优化:
   - 资源预加载
   - 节点缓存
   - 懒加载
```

### 开发优先级

```yaml
Phase 1 (MVP):
  - [x] 变量系统（16个）
  - [ ] 核心函数（10个）
  - [ ] 基础积木（5个）
  - [ ] 节点加载系统
  - [ ] 简单存档

Phase 2:
  - [ ] 完整积木（10个）
  - [ ] 高级存档
  - [ ] 性能优化
  - [ ] 调试工具

Phase 3:
  - [ ] 统计系统
  - [ ] 成就系统
  - [ ] 云存档
```

---

**下一章**: [07-内容制作规范](./07-内容制作规范.md) - 节点创作与文本撰写

---

**最后更新**: 2025-10-29  
**文档状态**: ✅ 完成  
**版本**: v1.0

